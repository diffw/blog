{{ define "main" }}
{{ if .Content }}
<div class="home-page-content">
  {{/* Get the now.md page */}}
  {{ $nowPage := .Site.GetPage "page" "now" }}
  {{ $nowFirstModule := "" }}
  {{ if $nowPage }}
    {{/* Use RawContent to get the raw body (no front matter) */}}
    {{ $nowContent := replace $nowPage.RawContent "\r\n" "\n" }}
    {{/* Split on full-line `---` and take the first module (before the first `---`) */}}
    {{ $parts := split $nowContent "\n---\n" }}
    {{ if gt (len $parts) 0 }}
      {{ $nowFirstModule = index $parts 0 | strings.TrimSpace }}
    {{ else }}
      {{ $nowFirstModule = $nowContent | strings.TrimSpace }}
    {{ end }}

    {{/* Render as Markdown */}}
    {{ if and $nowFirstModule (ne $nowFirstModule "") }}
      {{ $nowFirstModule = $nowPage.RenderString $nowFirstModule }}
    {{ end }}
  {{ end }}
  
  {{/* Get the latest blog post */}}
  {{ $posts := .Site.GetPage "section" "posts" }}
  {{ $latestPostContent := "" }}
  {{ if $posts }}
    {{ $sortedPosts := sort $posts.Pages "Date" "desc" }}
    {{ if gt (len $sortedPosts) 0 }}
      {{ $latestPost := index $sortedPosts 0 }}
      {{/* Use the same styling as list pages */}}
      {{ $content := $latestPost.Content | plainify }}
      {{ $contentLength := len $content }}
      {{ $contentHTML := "" }}
      {{ if gt $contentLength 800 }}
        {{ $truncated := $content | truncate 800 }}
        {{ $contentHTML = printf "<div class=\"post-content-full\">%s</div><a href=\"%s\" class=\"read-more\">Read more...</a>" $truncated $latestPost.Permalink }}
      {{ else }}
        {{ $contentHTML = printf "<div class=\"post-content-full\">%s</div>" $content }}
      {{ end }}
      {{ $tagsHTML := "" }}
      {{ if $latestPost.Params.tags }}
        {{ $tagsList := slice }}
        {{ range $latestPost.Params.tags }}
          {{ $tagsList = $tagsList | append (printf "<a href=\"/tags/%s\" class=\"tag\">#%s</a>" (. | urlize) .) }}
        {{ end }}
        {{ $tagsHTML = printf "<div class=\"post-tags\">%s</div>" (delimit $tagsList "") }}
      {{ end }}
      {{ $latestPostContent = printf "<article class=\"post-card\"><div class=\"post-content-preview\">%s</div><div class=\"post-meta-bottom\"><time datetime=\"%s\">%s</time>%s</div></article>" $contentHTML ($latestPost.Date.Format "2006-01-02") ($latestPost.Date.Format "January 2, 2006") $tagsHTML }}
    {{ end }}
  {{ end }}
  
  {{/* Get raw content, replace placeholders, then render */}}
  {{ $rawContent := .RawContent }}
  {{ if and $nowFirstModule (ne $nowFirstModule "") }}
    {{ $rawContent = replace $rawContent "/ Read the first module from now.md" $nowFirstModule }}
  {{ else }}
    {{/* If extraction fails, use default content */}}
    {{ $nowFirstModule = "<p>Building a chrome extension with Cursor. It's been so fun and exciting. It feels as if I've gone back 20 years—to the days of building personal websites with Flash, Dreamweaver, and Photoshop. I've found a new toy.</p>\n<p><em>Last update: Nov 28, 2025</em></p>" }}
    {{ $rawContent = replace $rawContent "/ Read the first module from now.md" $nowFirstModule }}
  {{ end }}
  {{ if and $latestPostContent (ne $latestPostContent "") }}
    {{ $rawContent = replace $rawContent "/ Read the latest post from https://nanwang.art/posts/" $latestPostContent }}
  {{ end }}
  
  {{/* Render processed content */}}
  {{ $rawContent | .RenderString }}
</div>
{{ else }}
<div class="home-page">
  <div class="posts-list">
    {{ $posts := .Site.GetPage "section" "posts" }}
    {{ range first 10 $posts.Pages }}
    <article class="post-card">
      <div class="post-content-preview">
        {{ $content := .Content | plainify }}
        {{ $contentLength := len $content }}
        {{ if gt $contentLength 800 }}
          {{ $truncated := $content | truncate 800 }}
          <div class="post-content-full">{{ $truncated }}</div>
          <a href="{{ .Permalink }}" class="read-more">Read more...</a>
        {{ else }}
          <div class="post-content-full">{{ $content }}</div>
        {{ end }}
      </div>
      <div class="post-meta-bottom">
        <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
        {{ if .Params.tags }}
        <div class="post-tags">
          {{ range .Params.tags }}
          <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}" class="tag">#{{ . }}</a>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </article>
    {{ end }}
  </div>
  
  {{ if gt (len $posts.Pages) 10 }}
  <div class="more-posts">
    <a href="{{ "/posts/" | relLangURL }}" class="btn">View More Posts →</a>
  </div>
  {{ end }}
</div>
{{ end }}
{{ end }}

