{{ define "main" }}
{{ if .Content }}
<div class="home-page-content">
  {{/* 获取 now.md 页面 */}}
  {{ $nowPage := .Site.GetPage "page" "now" }}
  {{ $nowFirstModule := "" }}
  {{ if $nowPage }}
    {{/* 使用 RawContent 获取原始内容（不包含 front matter） */}}
    {{ $nowContent := replace $nowPage.RawContent "\r\n" "\n" }}
    {{/* 按整行 --- 分割内容，取第一个模块（第一个 --- 之前） */}}
    {{ $parts := split $nowContent "\n---\n" }}
    {{ if gt (len $parts) 0 }}
      {{ $nowFirstModule = index $parts 0 | strings.TrimSpace }}
    {{ else }}
      {{ $nowFirstModule = $nowContent | strings.TrimSpace }}
    {{ end }}

    {{/* 渲染为 Markdown */}}
    {{ if and $nowFirstModule (ne $nowFirstModule "") }}
      {{ $nowFirstModule = $nowPage.RenderString $nowFirstModule }}
    {{ end }}
  {{ end }}
  
  {{/* 获取最新的一篇博客 */}}
  {{ $posts := .Site.GetPage "section" "posts" }}
  {{ $latestPostContent := "" }}
  {{ if $posts }}
    {{ $sortedPosts := sort $posts.Pages "Date" "desc" }}
    {{ if gt (len $sortedPosts) 0 }}
      {{ $latestPost := index $sortedPosts 0 }}
      {{/* 使用与列表页面相同的样式 */}}
      {{ $content := $latestPost.Content | plainify }}
      {{ $contentLength := len $content }}
      {{ $contentHTML := "" }}
      {{ if gt $contentLength 800 }}
        {{ $truncated := $content | truncate 800 }}
        {{ $contentHTML = printf "<div class=\"post-content-full\">%s</div><a href=\"%s\" class=\"read-more\">Read more...</a>" $truncated $latestPost.Permalink }}
      {{ else }}
        {{ $contentHTML = printf "<div class=\"post-content-full\">%s</div>" $content }}
      {{ end }}
      {{ $tagsHTML := "" }}
      {{ if $latestPost.Params.tags }}
        {{ $tagsList := slice }}
        {{ range $latestPost.Params.tags }}
          {{ $tagsList = $tagsList | append (printf "<a href=\"/tags/%s\" class=\"tag\">#%s</a>" (. | urlize) .) }}
        {{ end }}
        {{ $tagsHTML = printf "<div class=\"post-tags\">%s</div>" (delimit $tagsList "") }}
      {{ end }}
      {{ $latestPostContent = printf "<article class=\"post-card\"><div class=\"post-content-preview\">%s</div><div class=\"post-meta-bottom\"><time datetime=\"%s\">%s</time>%s</div></article>" $contentHTML ($latestPost.Date.Format "2006-01-02") ($latestPost.Date.Format "January 2, 2006") $tagsHTML }}
    {{ end }}
  {{ end }}
  
  {{/* 获取原始内容并替换占位符，然后渲染 */}}
  {{ $rawContent := .RawContent }}
  {{ if and $nowFirstModule (ne $nowFirstModule "") }}
    {{ $rawContent = replace $rawContent "/读取 now.md 第一个模块的内容" $nowFirstModule }}
  {{ else }}
    {{/* 如果提取失败，使用默认内容 */}}
    {{ $nowFirstModule = "<p>Building a chrome extension with Cursor. It's been so fun and exciting. It feels as if I've gone back 20 years—to the days of building personal websites with Flash, Dreamweaver, and Photoshop. I've found a new toy.</p>\n<p><em>Last update: Nov 28, 2025</em></p>" }}
    {{ $rawContent = replace $rawContent "/读取 now.md 第一个模块的内容" $nowFirstModule }}
  {{ end }}
  {{ if and $latestPostContent (ne $latestPostContent "") }}
    {{ $rawContent = replace $rawContent "/读取 https://nanwang.art/posts/ 第一篇blog" $latestPostContent }}
  {{ end }}
  
  {{/* 渲染处理后的内容 */}}
  {{ $rawContent | .RenderString }}
</div>
{{ else }}
<div class="home-page">
  <div class="posts-list">
    {{ $posts := .Site.GetPage "section" "posts" }}
    {{ range first 10 $posts.Pages }}
    <article class="post-card">
      <div class="post-content-preview">
        {{ $content := .Content | plainify }}
        {{ $contentLength := len $content }}
        {{ if gt $contentLength 800 }}
          {{ $truncated := $content | truncate 800 }}
          <div class="post-content-full">{{ $truncated }}</div>
          <a href="{{ .Permalink }}" class="read-more">Read more...</a>
        {{ else }}
          <div class="post-content-full">{{ $content }}</div>
        {{ end }}
      </div>
      <div class="post-meta-bottom">
        <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
        {{ if .Params.tags }}
        <div class="post-tags">
          {{ range .Params.tags }}
          <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}" class="tag">#{{ . }}</a>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </article>
    {{ end }}
  </div>
  
  {{ if gt (len $posts.Pages) 10 }}
  <div class="more-posts">
    <a href="{{ "/posts/" | relLangURL }}" class="btn">View More Posts →</a>
  </div>
  {{ end }}
</div>
{{ end }}
{{ end }}

