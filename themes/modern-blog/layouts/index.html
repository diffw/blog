{{ define "main" }}
{{ if .Content }}
<div class="home-page-content">
  {{/* 获取 now.md 页面 */}}
  {{ $nowPage := .Site.GetPage "page" "now" }}
  {{ $nowFirstModule := "" }}
  {{ if $nowPage }}
    {{ $nowContent := $nowPage.RawContent }}
    {{/* 按 --- 分割内容 */}}
    {{ $parts := split $nowContent "---" }}
    {{/* 提取第 2 个与第 3 个 --- 之间的内容（索引 2，因为 split 会得到多个部分） */}}
    {{ if ge (len $parts) 3 }}
      {{ $nowFirstModule = index $parts 2 }}
      {{/* 清理前后空白，但保留内部换行 */}}
      {{ $nowFirstModule = $nowFirstModule | strings.TrimSpace }}
      {{/* 渲染为 Markdown，保留换行 */}}
      {{ if and $nowFirstModule (ne $nowFirstModule "") }}
        {{ $nowFirstModule = $nowFirstModule | .RenderString }}
      {{ end }}
    {{ end }}
    {{/* 如果 nowFirstModule 为空，使用默认内容（包含时间） */}}
    {{ if not $nowFirstModule }}
      {{ $nowFirstModule = "<p>Building a chrome extension with Cursor.</p>\n<p>Last update: Nov 28, 2025</p>" }}
    {{ end }}
  {{ end }}
  
  {{/* 获取最新的一篇博客 */}}
  {{ $posts := .Site.GetPage "section" "posts" }}
  {{ $latestPostContent := "" }}
  {{ if $posts }}
    {{ $sortedPosts := sort $posts.Pages "Date" "desc" }}
    {{ if gt (len $sortedPosts) 0 }}
      {{ $latestPost := index $sortedPosts 0 }}
      {{/* 使用与列表页面相同的样式 */}}
      {{ $content := $latestPost.Content | plainify }}
      {{ $contentLength := len $content }}
      {{ $contentHTML := "" }}
      {{ if gt $contentLength 1000 }}
        {{ $truncated := $content | truncate 1000 }}
        {{ $contentHTML = printf "<div class=\"post-content-full\">%s</div><a href=\"%s\" class=\"read-more\">Read more...</a>" $truncated $latestPost.Permalink }}
      {{ else }}
        {{ $contentHTML = printf "<div class=\"post-content-full\">%s</div>" $content }}
      {{ end }}
      {{ $tagsHTML := "" }}
      {{ if $latestPost.Params.tags }}
        {{ $tagsList := slice }}
        {{ range $latestPost.Params.tags }}
          {{ $tagsList = $tagsList | append (printf "<a href=\"/tags/%s\" class=\"tag\">#%s</a>" (. | urlize) .) }}
        {{ end }}
        {{ $tagsHTML = printf "<div class=\"post-tags\">%s</div>" (delimit $tagsList "") }}
      {{ end }}
      {{ $latestPostContent = printf "<article class=\"post-card\"><div class=\"post-content-preview\">%s</div><div class=\"post-meta-bottom\"><time datetime=\"%s\">%s</time>%s</div></article>" $contentHTML ($latestPost.Date.Format "2006-01-02") ($latestPost.Date.Format "January 2, 2006") $tagsHTML }}
    {{ end }}
  {{ end }}
  
  {{/* 获取原始内容并替换占位符，然后渲染 */}}
  {{ $rawContent := .RawContent }}
  {{ if $nowFirstModule }}
    {{ $rawContent = replace $rawContent "/读取 now.md 第一个模块的内容" $nowFirstModule }}
  {{ end }}
  {{ if $latestPostContent }}
    {{ $rawContent = replace $rawContent "/读取 https://nanwang.art/posts/ 第一篇blog" $latestPostContent }}
  {{ end }}
  
  {{/* 渲染处理后的内容 */}}
  {{ $rawContent | .RenderString }}
</div>
{{ else }}
<div class="home-page">
  <div class="posts-list">
    {{ $posts := .Site.GetPage "section" "posts" }}
    {{ range first 10 $posts.Pages }}
    <article class="post-card">
      <div class="post-content-preview">
        {{ $content := .Content | plainify }}
        {{ $contentLength := len $content }}
        {{ if gt $contentLength 1000 }}
          {{ $truncated := $content | truncate 1000 }}
          <div class="post-content-full">{{ $truncated }}</div>
          <a href="{{ .Permalink }}" class="read-more">Read more...</a>
        {{ else }}
          <div class="post-content-full">{{ $content }}</div>
        {{ end }}
      </div>
      <div class="post-meta-bottom">
        <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
        {{ if .Params.tags }}
        <div class="post-tags">
          {{ range .Params.tags }}
          <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}" class="tag">#{{ . }}</a>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </article>
    {{ end }}
  </div>
  
  {{ if gt (len $posts.Pages) 10 }}
  <div class="more-posts">
    <a href="{{ "/posts/" | relLangURL }}" class="btn">View More Posts →</a>
  </div>
  {{ end }}
</div>
{{ end }}
{{ end }}

